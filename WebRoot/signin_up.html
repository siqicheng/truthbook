<!DOCTYPE html>
<html lang="en">
<head>
   	<meta charset="utf-8">
   	<title>登陆 | Truthbook</title>

   	<link href="./assets/semantic/css/semantic.css" rel="stylesheet">
   	<!-- location CSS -->
   	<link href="./CSS/position.css" rel="stylesheet">
   	<link rel="shortcut icon" href="img/logo.ico" /> 

</head>

<body class="body_bg">
	<div class="absolute-center" style="width:380px; height:400px">
		<img src="img/Truthbook_capital.png" width="380" >
		<!-- login form -->
		<form class="ui form login-form" style="width:300px; margin-left: 40px;">	    		
			<!--username field-->
  			<div class="field">
    			<div class="ui left labeled icon input">
      				<input type="text" id="email" name="email" placeholder="用户名">
      				<i class="user icon"></i>
    			</div>
    		</div>
    		<!--password field-->
    		<div class="field">
    			<div class="ui left icon input">
      				<input type="password" id="password" name="password" placeholder="密码">
      				<i class="lock icon"></i>
    			</div>
  			</div>
  			<input class="ui fluid blue button" type ="submit" id="loginBtn" value = "登录">
  			<div id="resText"></div>
  			<div class="ui error message" id="errormessage" style="display: none">用户名或密码不正确</div>
		</form>
		
		<!-- register form, display none in default -->
		<form class="ui form register-form" style="width:300px; margin-left: 40px; display: none;">	                
                <!-- fullName field -->
                <div class="field">
                    <div class="ui left labeled icon input">
                        <input type="text" id="fullName" placeholder="姓名" name="fullName">
                        <i class="user icon"></i>
                    </div>
                </div>	                
                <!-- school field -->
                <div class="field">
                    <div class="ui left labeled icon input">
                        <input type="text" id="school" placeholder="学校： 复旦大学/北京大学" name="school">
                        <i class="book icon"></i>
                    </div>
                </div>	                
                <!-- entryTime field -->
				<div class="field">
                    <div class="ui left labeled icon input">
                        <input type="text" id="entryTime" placeholder="入学年份： 2008/2012" name="entryTime">
                        <i class="align justify icon"></i>
                    </div>
                </div>	
                <!-- email field -->
                <div class="field">
                    <div class="ui left labeled icon input">
                    
                        <input type="text" id="email" name="email" placeholder="邮箱" onchange="checkEmail(this.value)" >
                       	<div class="ui corner label" id = "cornerlabel" style="display: none"> 
	  	            		<i class="checkmark small icon" id="correctmessage" style="display: none"></i>
	                	</div> 
                        
                        <span id="txtHint" ></span>
                        <i class="mail icon"></i>
              		</div>                    
                </div>
                <div class="field">
                	<div class="ui red pointing prompt label transition" id="errormessage" style="display: none;">邮箱已存在，换个小号吧</div>
				</div>
                <!--password field-->
                <div class="field">
                    <div class="ui left icon input">
                        <input type="password" id="password" name="password" placeholder="密码">
                        <i class="lock icon"></i>
                    </div>
                </div>
	  			<input class="ui disabled fluid blue button" type ="submit" id="register_button" value = "注册">
        </form>
	</div>
	        	
    <!-- register&login toggle button -->
	<div class="bottom-left">
	    <button class="ui basic animated button" id="registerToggle"> 
	        <div class="visible content"> 注册 </div>
	        <div class="hidden content">
	            <i class="pencil icon"></i>
	        </div>
	    </button>
 	    <button class="ui basic animated button" id="loginToggle" style="display:none;"> 
           <div class="visible content"> 登录 </div>
           <div class="hidden content">
               <i class="sign in icon"></i>
           </div>
       </button>
	</div>
     	
	<script src="./assets/jquery/jquery-1.7.2.js"></script>
	<script src="./assets/semantic/javascript/semantic.js"></script>
	<script src="./js/form_toggle.js"></script>
	<script src="./js/general/utility.js"></script> 	
	<script type="text/javascript">
		function Redirect (url) {
			var ua        = navigator.userAgent.toLowerCase(),
				isIE      = ua.indexOf('msie') !== -1,
				version   = parseInt(ua.substr(4, 2), 10);

			// IE8 and lower
			if (isIE && version < 9) {
				var link = document.createElement('a');
				link.href = url;
				document.body.appendChild(link);
				link.click();
			}

			// All other browsers
			else { window.location.href = url; }
		}
	</script>
	<script type="text/javascript">
	//login form functions
		$(function() {				
			//form validation
			$( '.ui.form.login-form' )
				.form({
				    username: {
				      identifier : 'username',
				      rules: [
				        {
				          type   : 'empty',
				          prompt : '请输入注册邮箱'
				        }
				      ]
				    },
				    password: {
				      identifier : 'password',
				      rules: [
				        {
				          type   : 'empty',
				          prompt : '请输入密码'
				        },
				        {
				          type   : 'length[6]',
				          prompt : '密码至少要6位'
				        }
				      ]
				    }
				},{//form settings(semantics)
					on: 'blur',
    				inline: 'true',
    				onFailure : function() {

						},
					onSuccess : function () {
						
					}
				});
				
				$('.ui.form.login-form')
				.submit(function(){
					var url="http://localhost:8080/truthbook/services/loginService/v1/login";
					var data= $('.ui.form').serialize();
					var onSuccess = function(data,textStatus){
						if (data == "true"){
							window.location.href = "http://localhost:8080/truthbook/profile_test.html";
							return true;
						}
						else{
							$("#errormessage").show();
							$("#errormessage").text("Login failed. Please validate your username/password.");
							console.log("Login failed. Please validate your username/password.");
							return false;
						}
					};
					
					var ajax_obj = getAjaxObj(url,"POST","text",onSuccess);
					ajax_obj.data = data;
					ajax_call(ajax_obj);
					return false;					
				});				
				
				
				$(document).ajaxStart(function(email, password) {
					$("#loginBtn").addClass("loading");
				});			
				$(document).ajaxStop(function() {
					$("#loginBtn").removeClass("loading");
				});
				$(document).ajaxError(function() {
					$("#errormessage").show();
				});
		});
	</script>
	
	<script type="text/javascript">
	// register form functions
		function checkEmail(email){
			if (email.length==0)
			{ 
				$("#cornerlabel").hide();
				$("#errormessage").hide();
				$("#correctmessage").hide();
				return;
			}
			var url = "http://localhost:8080/truthbook/services/loginService/v1/email/"+email;
			var onSuccess = function (data,textStatus){
				if(data == "true"){
					$("#errormessage").show();
					$("#register_button").addClass("disabled")						 
				}
				else{
					$("#errormessage").hide();
					$("#cornerlabel").show();
					$("#correctmessage").show();
					$("#register_button").removeClass("disabled")
				}
				console.log("status:"+textStatus+" data:"+data);
			};
			var onError = function(xhr,status,error){
				$("#errormessage").show();
				$("#errormessage").text("status:"+status+" error:"+error);
				console.log("status:"+status+" error:"+error);
				
			}
			var ajax_obj = getAjaxObj(url,"GET","text",onSuccess);
			ajax_call(ajax_obj);
		}
		        
        $(function() {        	
            $('.ui.form.register-form')
                .form({
                    username: {
                        identifier : 'fullName',
                        rules: [
                        {
                            type   : 'empty',
                            prompt : '给个真名呗'
                        }
                        ]
                    },
                    school: {
                        identifier : 'school',
                        rules: [
                        {
                            type   : 'empty',
                            prompt : '告诉我们你的学校吧'
                        }
                        ]
                    },
                    age: {
                        identifier : 'entryTime',
                        rules: [
                        {
                            type   : 'empty',
                            prompt : '哪年入的校呢？'
                        },
                        {
                            type   : 'isYear',
                            prompt : '这个年份好像不对啊？'
                        },
                        {
                            type   : 'earlyYear[1976]',
                            prompt : '您这么早就入学了？'
                        },
                        {
                            type   : 'lateYear[2015]',
                            prompt : '今年才2014年吧？'
                        },
                        ]
                    },
                    password: {
                        identifier : 'password',
                        rules: [
                        {
                            type   : 'empty',
                            prompt : '请输入密码'
                        },
                        {
                            type   : 'length[6]',
                            prompt : '密码至少6位'
                        }
                        ]
                    },
                    email: {
                        identifier: 'email',
                        rules:[
                        {
                            type   : 'email',
                            prompt : '请输入正确的邮箱'
                        }
                        ]
                    }
                },{
                    on: 'blur',
                    inline: 'true',
    				onFailure : function() {
						
					},
					onSuccess : function () {
						
					}
                });
			$('.ui.form.register-form')
				.submit(function(){
					var url="http://localhost:8080/truthbook/services/loginService/v1/register";
					var data= $('.ui.form').serialize();
					var onSuccess = function(data,textStatus){
						if (data == "success"){
							console.log("success");
							window.location.href = "http://localhost:8080/truthbook/profile_test.html";
							return true;
						}
					};
					var onError = function(xhr,status,error){
						$("#errormessage").show();
						$("#errormessage").text("Register failed with error:" + error);
						console.log("Register failed with error:" + error);
						return false;
					}
					var ajax_obj = getAjaxObj(url,"POST","text",onSuccess,onError);
					ajax_obj.data = data;
					ajax_call(ajax_obj);
					return false;					
				});				
        }); 
	</script>	